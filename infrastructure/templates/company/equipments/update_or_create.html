{% extends 'base.html' %}

{% set is_create = (view_type == 'create') %}
{% block title %}
{{ last_name|capitalize }} {{ name|capitalize }} {{ patronymic|capitalize }} |
{% if is_create %}–°–æ–∑–¥–∞–Ω–∏–µ{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endif %} –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
{% endblock %}

{% block content %}
<h1 class="fs-xl d-flex flex-column align-items-center mb-4">
  {% if company_image %}
  <div class="photo mb-3">
    <img src="data:image/jpeg;base64,{{ company_image }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏: {{ company_name }}">
  </div>
  {% endif %}
  <div class="btn-group mb-3">
    <a href="/companies/equipments?company_id={{company_id}}" class="btn btn-outline-secondary label-text fw-bold"
      style="border-width: 3px;">üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</a>
    <a href="/companies/company?company_id={{company_id}}" class="btn btn-outline-dark label-text fw-bold"
      style="border-width: 3px;">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>
  {% if is_create %}–°–æ–∑–¥–∞–Ω–∏–µ{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endif %} –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
</h1>

<div class="card p-4 mb-5">
  <form method="{% if is_create %}POST{% else %}PUT{% endif %}" action="
      {% if is_create %}
        /companies/api/equipments/create?company_id={{company_id}}
      {% else %}
        /companies/api/equipments/update?company_id={{company_id}}&equipment_id={{equipment.id}}
      {% endif %}" enctype="multipart/form-data" id="equipment-form">

    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="image" class="form-label label-text"><b>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</b></label>
        <input type="file" id="image" name="image" class="form-control input-text" accept="image/*">
      </div>
      <div class="col-md-4 mb-3">
        <label for="image2" class="form-label label-text"><b>–í—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ</b></label>
        <input type="file" id="image2" name="image2" class="form-control input-text" accept="image/*">
      </div>
      <div class="col-md-4 mb-3">
        <label for="document_pdf" class="form-label label-text"><b>–î–æ–∫—É–º–µ–Ω—Ç (PDF)</b></label>
        <input type="file" id="document_pdf" name="document_pdf" accept="application/pdf"
          class="form-control input-text">
      </div>
    </div>

    <!-- –†—è–¥ 1 -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="name" class="form-label label-text"><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b></label>
        <input type="text" id="name" name="name" class="form-control input-text text-center"
          value="{{ equipment.name if not is_create and equipment else '' }}" required maxlength="80">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="full_name" class="form-label label-text"><b>–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</b></label>
        <input type="text" id="full_name" name="full_name" class="form-control input-text text-center"
          value="{{ equipment.full_name if not is_create and equipment else '' }}" required maxlength="150">
      </div>
    </div>

    <!-- –†—è–¥ 2 -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="factory_number" class="form-label label-text"><b>–ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä</b></label>
        <input type="text" id="factory_number" name="factory_number" class="form-control input-text text-center"
          value="{{ equipment.factory_number if not is_create and equipment else '' }}" required maxlength="30"
          pattern="^[\w\d\s\-,.]+$">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="inventory_number" class="form-label label-text"><b>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</b></label>
        <input type="number" id="inventory_number" name="inventory_number" class="form-control input-text text-center"
          value="{{ equipment.inventory_number if not is_create and equipment else '' }}" required min="0" step="1">
      </div>
    </div>

    <!-- –†—è–¥ 3 -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="year_of_issue" class="form-label label-text"><b>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</b></label>
        <input type="number" id="year_of_issue" name="year_of_issue" class="form-control input-text text-center"
          value="{{ equipment.year_of_issue if not is_create and equipment else '' }}" required min="1901" max="2099"
          step="1">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="commissioning_year" class="form-label label-text"><b>–ì–æ–¥ –≤–≤–æ–¥–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é</b></label>
        <input type="number" id="commissioning_year" name="commissioning_year" required
          class="form-control input-text text-center"
          value="{{ equipment.commissioning_year if not is_create and equipment else '' }}" min="1900" max="2100"
          step="1">
      </div>
    </div>

    <!-- –†—è–¥ 4: –≤—ã–±–æ—Ä—ã -->
    {% set eq_act_id = (
    equipment.activity_id if equipment and equipment.activity_id
    else (equipment.activity.id if equipment and equipment.activity else '')
    ) %}
    {% set eq_si_id = (
    equipment.si_type_id if equipment and equipment.si_type_id
    else (equipment.si_type.id if equipment and equipment.si_type else '')
    ) %}

    <div class="row">
      <div class="col-lg-6 mb-3">
        <label class="form-label label-text"><b>–í–∏–¥—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π</b></label>
        <input type="hidden" id="activity_id" name="activity_id" value="{{ eq_act_id }}">
        <div class="border p-3 rounded">
          {% for a in activities %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="activity_choice" value="{{ a.id }}" {% if eq_act_id==a.id
              %}checked{% endif %} onclick="document.getElementById('activity_id').value=this.value">
            <label class="form-check-label">{{ a.name }}</label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <label class="form-label label-text"><b>–¢–∏–ø —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π</b></label>
        <input type="hidden" id="si_type_id" name="si_type_id" value="{{ eq_si_id }}">
        <div class="border p-3 rounded">
          {% for s in si_types %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="si_choice" value="{{ s.id }}" {% if eq_si_id==s.id
              %}checked{% endif %} onclick="document.getElementById('si_type_id').value=this.value">
            <label class="form-check-label">{{ s.name }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- –†—è–¥ 5 -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="manufacturer_country" class="form-label label-text"><b>–°—Ç—Ä–∞–Ω–∞ –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è</b></label>
        <input type="text" id="manufacturer_country" name="manufacturer_country"
          class="form-control input-text text-center"
          value="{{ equipment.manufacturer_country if not is_create and equipment else '' }}" maxlength="120">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="manufacturer_name" class="form-label label-text"><b>–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å</b></label>
        <input type="text" id="manufacturer_name" name="manufacturer_name" class="form-control input-text text-center"
          value="{{ equipment.manufacturer_name if not is_create and equipment else '' }}" maxlength="255">
      </div>
    </div>

    <!-- –†—è–¥ 6 -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="ownership_document" class="form-label label-text"><b>–î–æ–∫—É–º–µ–Ω—Ç –≤–ª–∞–¥–µ–Ω–∏—è/–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</b></label>
        <input type="text" id="ownership_document" name="ownership_document" class="form-control input-text text-center"
          value="{{ equipment.ownership_document if not is_create and equipment else '' }}" maxlength="255">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="storage_place" class="form-label label-text"><b>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏/—Ö—Ä–∞–Ω–µ–Ω–∏—è</b></label>
        <input type="text" id="storage_place" name="storage_place" class="form-control input-text text-center"
          value="{{ (equipment.storage_place or place if equipment else place) or '' }}" maxlength="255">
      </div>
    </div>

    <!-- –î–∏–∞–ø–∞–∑–æ–Ω—ã -->
    <div class="mb-3" id="rangesWrapper">
      <label class="form-label label-text"><b>–î–∏–∞–ø–∞–∑–æ–Ω—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π –∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å</b></label>
      <div id="ranges-container">
        {% set ranges = (equipment.measurement_range or '').split('|') if equipment and equipment.measurement_range else
        [''] %}
        {% set errors = (equipment.error_or_uncertainty or '').split('|') if equipment and
        equipment.error_or_uncertainty else [''] %}
        {% set count = ranges|length if ranges|length > errors|length else errors|length %}
        {% for i in range(count) %}
        <div class="d-flex mb-2 range-row">
          <input type="text" name="measurement_range_item" class="form-control input-text text-center me-2"
            placeholder="–î–∏–∞–ø–∞–∑–æ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä: (0,1...10) –º¬≥/—á" value="{{ ranges[i] if i < ranges|length else '' }}">
          <input type="text" name="error_or_uncertainty_item" class="form-control input-text text-center me-2"
            placeholder="–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: 1" value="{{ errors[i] if i < errors|length else '' }}">
          <button type="button" class="btn btn-outline-danger fw-bold remove-range"
            style="border-width: 3px;">‚úñ</button>
        </div>
        {% endfor %}
      </div>
      <button type="button" id="add-range" class="btn btn-outline-success btn-sm mt-2 fw-bold"
        style="border-width: 3px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

      <input type="hidden" id="measurement_range" name="measurement_range">
      <input type="hidden" id="error_or_uncertainty" name="error_or_uncertainty">

      <div class="form-text">
        –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ ¬´(–∑–Ω–∞—á–µ–Ω–∏–µ) –º¬≥/—á¬ª, –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å ‚Äî ¬´–ü–ì ¬±(–∑–Ω–∞—á–µ–Ω–∏–µ)%¬ª.
        –î–ª—è —Ç–∏–ø–æ–≤ ¬´–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ¬ª –∏ ¬´–î—Ä—É–≥–æ–µ¬ª –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è.
      </div>
    </div>

    <!-- –ü–û –∏ —Ç–∏–ø -->
    <div class="row">
      <div class="col-lg-6 mb-3">
        <label for="software_identifier" class="form-label label-text"><b>–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –ü–û</b></label>
        <input type="text" id="software_identifier" name="software_identifier"
          class="form-control input-text text-center"
          value="{{ equipment.software_identifier if (not is_create or equipment) and equipment.software_identifier else '' }}"
          maxlength="255">
      </div>

      <div class="col-lg-6 mb-3">
        <label for="type" class="form-label label-text"><b>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</b></label>
        <select id="type" name="type" class="form-select input-text text-center" onchange="toggleFields()" required>
          {% for key, value in {
          'standard': '–°—Ä–µ–¥—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —ç—Ç–∞–ª–æ–Ω–∞',
          'measurement': '–°—Ä–µ–¥—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π',
          'auxiliary': '–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',
          'other': '–î—Ä—É–≥–æ–µ'
          }.items() %}
          <option value="{{ key }}" {% if (not is_create or equipment) and equipment.type==key %}selected{% endif %}>{{
            value }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- –ì–æ—Å—Ä–µ–µ—Å—Ç—Ä / –ü–µ—Ä–µ—á–µ–Ω—å / –û–ø—Ç–æ—Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å -->
    <div class="row">
      <div class="col-md-6 mb-3" id="registerNumberWrapper">
        <label for="register_number" class="form-label label-text"><b>–ù–æ–º–µ—Ä –≥–æ—Å.—Ä–µ–µ—Å—Ç—Ä–∞</b></label>
        <input type="text" id="register_number" name="register_number" class="form-control input-text text-center"
          value="{{ equipment.register_number if not is_create and equipment else '' }}" maxlength="100">
      </div>

      <div class="col-md-6 mb-3" id="listNumberWrapper">
        <label for="list_number" class="form-label label-text"><b>–ù–æ–º–µ—Ä –≤ –ø–µ—Ä–µ—á–Ω–µ</b></label>
        <input type="text" id="list_number" name="list_number" class="form-control input-text text-center"
          value="{{ equipment.list_number if not is_create and equipment else '' }}" maxlength="100">
      </div>

      <div class="col-md-6 mb-3" id="isOptWrapper">
        <label for="is_opt" class="form-label label-text"><b>–û–ø—Ç–æ—Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å</b></label>
        <div class="d-flex justify-content-center">
          <input type="checkbox" id="is_opt" name="is_opt" class="form-check-input me-2" {% if not is_create and
            equipment is defined and equipment and equipment.is_opt %}checked{% endif %}>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-outline-success label-text fw-bold" style="border-width: 3px;">
        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>
    </div>
  </form>
</div>

<script>
  window.companyId = {{ company_id }};
  window.isCreate = {{ is_create | tojson }};
  {% if not is_create %}
  window.equipmentId = {{ equipment.id }};
  {% endif %}
</script>
<script type="module" src="/static/company/equipments/js/update_or_create.js"></script>

{% endblock %}