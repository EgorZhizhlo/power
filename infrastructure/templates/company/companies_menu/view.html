<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Egor Zhizhlo Tg:@EgorZhizhlo" />
  <title>
    {% block title %}
    {{ last_name|capitalize }} {{ name|capitalize }} {{ patronymic|capitalize }} | –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏—è–º–∏
    {% endblock %}
  </title>
  <link rel="icon" href="/static/logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" type="text/css" href="/static/company/companies_menu/css/styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <style>
    .company-text {
      column-gap: 2rem;
    }

    .company-text p {
      break-inside: avoid;
      margin-bottom: 0.5rem;
    }

    @media (min-width: 1400px) {
      .company-text {
        columns: 2;
        /* 2 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö –∏ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
      }
    }

    @media (max-width: 1400px) {
      .company-text {
        columns: 1;
        /* 1 –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö */
      }
    }
  </style>
</head>

<body class="d-flex flex-column h-100">
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top py-1">
      <div class="container-fluid d-flex justify-content-between align-items-center">
        <a class="navbar-brand fs-xl py-0 px-2 m-0" href="/companies">
          <h2 class=" m-0 p-1">
            {% block username %}
            {{ last_name|capitalize }} {{ name|capitalize }} {{ patronymic|capitalize }}
            {% endblock %}
          </h2>
        </a>
        <button class="navbar-toggler py-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
          aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item px-1">
              <a class="nav-link fs-base py-2 fs-lg" href="/tariff/">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏</a>
            </li>
            <li class="nav-item px-1">
              <a class="nav-link fs-base py-2 fs-lg" href="/logout">–í—ã–π—Ç–∏</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>


  <main class="container-fluid mt-5 content flex-grow-1 px-5">
    <h2 class="text-center mb-4 mt-0">–ú–æ–∏ –∫–æ–º–ø–∞–Ω–∏–∏</h2>
    <div class="mb-4 d-flex justify-content-center gap-3">
      <div class="input-group" style="flex-basis:60%;">
        <input type="text" id="search-input" style="font-size: var(--font-base);" class="form-control input-text"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–¥—Ä–µ—Å, email, –ò–ù–ù –∏ –§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞" oninput="filterCompanies()">
      </div>
      {% if status == "admin" %}
      <a href="/companies/create" class="btn btn-outline-primary label-text fw-bold"
        style="border-width: 3px; white-space: nowrap;">
        ‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
      </a>
      {% endif %}
    </div>

    {% if companies %}
    <div id="companies-list" class="row">
      {% for company in companies %}
      <div class="col-xl-6 col-12 mb-4">
        <div class="card company-item p-4 h-100 d-flex flex-column" data-name="{{ company.name|lower }}"
          data-address="{{ company.address|lower }}" data-inn="{{ company.inn|lower }}"
          data-email="{{ company.email|lower }}" data-person="{{ company.contact_responsible_person|lower }}"
          data-workplace="{{ company.workplace|lower }}"
          data-accreditation="{{ company.accreditation_certificat|lower }}"
          data-code="{{ company.organization_code|lower }}"
          onclick="location.href='/companies/company?company_id={{company.id}}'">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fs-lg m-0 p-0">
              {{ company.name }}
              {% if not company.is_active %}
              <span class="fs-sm text-secondary">(–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)</span>
              {% endif %}
            </h3>
            {% if company.get_image() %}
            <div class="photo">
              <img src="data:image/jpeg;base64,{{ company.get_image() }}" alt="Company Image">
            </div>
            {% endif %}
          </div>
          <hr>

          <div class="company-text fs-base flex-grow-1">
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ company.created_at | strftime_full(company.timezone or company_tz) }}</p>
            <p><strong>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</strong> {{ company.updated_at | strftime_full(company.timezone or company_tz) }}</p>

            <p><strong>Email:</strong> {{ company.email or '' }}</p>
            <p><strong>–ò–ù–ù:</strong> {{ company.inn or '' }}</p>
            <p><strong>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</strong> {{ company.address or '' }}</p>
            <p><strong>–ú–µ—Å—Ç–æ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</strong> {{ company.workplace or '' }}</p>
            <p><strong>–ê—Ç—Ç–µ—Å—Ç–∞—Ç –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏:</strong> {{ company.accreditation_certificat or '' }}</p>
            <p><strong>–®–∏—Ñ—Ä –∑–Ω–∞–∫–∞ –ø–æ–≤–µ—Ä–∫–∏:</strong> {{ company.organization_code or '' }}</p>
            <p><strong>–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞:</strong> {{ company.contact_responsible_person or '' }}</p>
            <p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> {{ (company.additional if company.additional) or
              '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}</p>

            <p><strong>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ¬´–ö–æ–º–∞–Ω–¥—ã¬ª:</strong> {% if company.auto_teams %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif
              %}</p>
            {% if company.auto_teams or status == 'admin' %}
            <p><strong>–ö–æ–ª-–≤–æ –ü–æ–≤–µ—Ä–æ–∫ –Ω–∞ –¥–µ–Ω—å:</strong> {{ company.daily_verifier_verif_limit or 0 }}</p>
            {% endif %}

            <p><strong>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ¬´–ú–µ—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏¬ª:</strong> {% if company.auto_metrolog %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{%
              endif %}</p>
            {% if company.auto_metrolog or status == 'admin' %}
            <p><strong>–î–æ–ª–≥–æ—Ç–∞:</strong> {{ company.longitude or 0 }}</p>
            <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> {{ company.latitude or 0 }}</p>
            {% endif %}

            <p><strong>–î–∞–≤–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</strong> {{ company.default_pressure }}</p>
            <p><strong>–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞:</strong> {{ (company.timezone or 'Europe/Moscow') | tz_name }}</p>
            <p><strong>–ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–¥–∞ –≤—ã–ø—É—Å–∫–∞ –°–ò:</strong> {% if company.auto_manufacture_year %}–í–∫–ª—é—á–µ–Ω–∞{% else
              %}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif %}</p>
            <p><strong>–ê–∫—Ç–∏–≤–Ω–∞:</strong> {% if company.is_active %}–î–∞{% else %}–ù–µ—Ç{% endif %}</p>

            {% if company.additional_checkbox_1 %}<p><strong>–î–æ–ø. —á–µ–∫–±–æ–∫—Å 1:</strong> {{ company.additional_checkbox_1
              }}</p>{% endif %}
            {% if company.additional_checkbox_2 %}<p><strong>–î–æ–ø. —á–µ–∫–±–æ–∫—Å 2:</strong> {{ company.additional_checkbox_2
              }}</p>{% endif %}
            {% if company.additional_checkbox_3 %}<p><strong>–î–æ–ø. —á–µ–∫–±–æ–∫—Å 3:</strong> {{ company.additional_checkbox_3
              }}</p>{% endif %}
            {% if company.additional_checkbox_4 %}<p><strong>–î–æ–ø. —á–µ–∫–±–æ–∫—Å 4:</strong> {{ company.additional_checkbox_4
              }}</p>{% endif %}
            {% if company.additional_checkbox_5 %}<p><strong>–î–æ–ø. —á–µ–∫–±–æ–∫—Å 5:</strong> {{ company.additional_checkbox_5
              }}</p>{% endif %}

            {% if company.additional_input_1 %}<p><strong>–î–æ–ø. –ø–æ–ª–µ 1:</strong> {{ company.additional_input_1 }}</p>{%
            endif %}
            {% if company.additional_input_2 %}<p><strong>–î–æ–ø. –ø–æ–ª–µ 2:</strong> {{ company.additional_input_2 }}</p>{%
            endif %}
            {% if company.additional_input_3 %}<p><strong>–î–æ–ø. –ø–æ–ª–µ 3:</strong> {{ company.additional_input_3 }}</p>{%
            endif %}
            {% if company.additional_input_4 %}<p><strong>–î–æ–ø. –ø–æ–ª–µ 4:</strong> {{ company.additional_input_4 }}</p>{%
            endif %}
            {% if company.additional_input_5 %}<p><strong>–î–æ–ø. –ø–æ–ª–µ 5:</strong> {{ company.additional_input_5 }}</p>{%
            endif %}
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <a href="/companies/update?company_id={{company.id}}"
              class="btn btn-outline-warning label-text fw-bold" style="border-width: 3px;"
              onclick="event.stopPropagation();">
              üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>

            {% if status == "admin" %}
            <button type="button" class="btn btn-outline-danger label-text fw-bold" style="border-width: 3px;"
              onclick="event.stopPropagation(); deleteCompany('/companies/api/delete?company_id={{company.id}}');"
              title="–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–≤—É—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤">
              üóë –£–¥–∞–ª–∏—Ç—å
            </button>

            {% if company.id in voted_company_ids %}
              <button type="button" class="btn btn-outline-secondary label-text fw-bold" style="border-width: 3px;"
                onclick="event.stopPropagation(); cancelDeleteVote('/companies/api/cancel?company_id={{company.id}}');"
                title="–û—Ç–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å –∑–∞ —É–¥–∞–ª–µ–Ω–∏–µ">
                ‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ—Å
              </button>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="card p-4 text-center">
      <h2 class="fs-lg">–£ –≤–∞—Å –Ω–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π</h2>
    </div>
    {% endif %}

    <script>
      function filterCompanies() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        document.querySelectorAll('.company-item').forEach(el => {
          // —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–ª—è, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∏—â–µ–º
          const fields = [
            el.dataset.name,
            el.dataset.address,
            el.dataset.inn,
            el.dataset.email,
            el.dataset.person,
            el.dataset.workplace,
            el.dataset.accreditation,
            el.dataset.code
          ];

          // –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
          const match = fields.some(f => f && f.includes(q));

          el.parentElement.style.display = (q === "" || match) ? "" : "none";
        });
      }

      async function deleteCompany(url) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏? –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω—É–∂–µ–Ω –≤—Ç–æ—Ä–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.')) {
          return;
        }
        try {
          const res = await fetch(url, { method: 'DELETE' });
          // –°–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç 303/200 ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫
          window.location.reload();
        } catch (e) {
          console.error(e);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ.');
        }
      }

      async function cancelDeleteVote(url) {
        if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –≤–∞—à –≥–æ–ª–æ—Å –∑–∞ —É–¥–∞–ª–µ–Ω–∏–µ?')) {
          return;
        }
        try {
          const res = await fetch(url, { method: 'POST' });
          window.location.reload();
        } catch (e) {
          console.error(e);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ—Å.');
        }
      }
    </script>
  </main>

  <footer class="footer bg-light text-center p-3 mt-auto">
    <div class="container-fluid">
      <span class="text-muted fs-base">&copy; –ú–æ–∏ –∫–æ–º–ø–∞–Ω–∏–∏</span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>