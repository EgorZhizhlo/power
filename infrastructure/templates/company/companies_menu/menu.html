{% extends 'base.html' %}

{% block title %}
{{ last_name|capitalize }} {{ name|capitalize }} {{ patronymic|capitalize }} |
{{ company_name }}{% if not company_is_active %} (неактивна){% endif %}
{% endblock %}

{% block content %}
<h1 class="fs-xl text-center d-flex flex-column align-items-center mb-4">
  {% if company_image %}
  <div class="photo mb-3">
    <img src="data:image/jpeg;base64,{{ company_image }}" alt="Изображение компании: {{ company_name }}">
  </div>
  {% endif %}
  Меню компании {{ company_name }}{% if not company_is_active %} (неактивна){% endif %}
</h1>

{% if tariff_info %}
  {% if tariff_info.has_tariff %}
    {% set is_expired = tariff_info.is_expired %}
    {% set valid_to = tariff_info.valid_to %}
    
    <div class="alert {% if is_expired %}alert-danger{% else %}alert-info{% endif %} mb-4 text-center">
      <h5 class="alert-heading mb-3">
        <i class="bi {% if is_expired %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
        Тариф{% if tariff_info.title %}: {{ tariff_info.title }}{% endif %}
      </h5>
      
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
          <strong>Сотрудники:</strong>
          {% if tariff_info.limits.max_employees == None %}
            <span class="text-success">Безлимит</span>
          {% elif tariff_info.limits.max_employees == 0 %}
            <span class="text-danger">Запрещено</span>
          {% else %}
            {{ tariff_info.limits.used_employees }} / {{ tariff_info.limits.max_employees }}
            <small class="text-muted">({{ tariff_info.percentages.employees }}%)</small>
            {% if tariff_info.percentages.employees >= 100 %}
              <i class="bi bi-exclamation-circle-fill text-danger"></i>
            {% elif tariff_info.percentages.employees >= 80 %}
              <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            {% endif %}
          {% endif %}
        </div>
        
        <div class="col-12 col-md-4">
          <strong>Поверки:</strong>
          {% if tariff_info.limits.max_verifications == None %}
            <span class="text-success">Безлимит</span>
          {% elif tariff_info.limits.max_verifications == 0 %}
            <span class="text-danger">Запрещено</span>
          {% else %}
            {{ tariff_info.limits.used_verifications }} / {{ tariff_info.limits.max_verifications }}
            <small class="text-muted">({{ tariff_info.percentages.verifications }}%)</small>
            {% if tariff_info.percentages.verifications >= 100 %}
              <i class="bi bi-exclamation-circle-fill text-danger"></i>
            {% elif tariff_info.percentages.verifications >= 80 %}
              <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            {% endif %}
          {% endif %}
        </div>
        
        <div class="col-12 col-md-4">
          <strong>Заявки:</strong>
          {% if tariff_info.limits.max_orders == None %}
            <span class="text-success">Безлимит</span>
          {% elif tariff_info.limits.max_orders == 0 %}
            <span class="text-danger">Запрещено</span>
          {% else %}
            {{ tariff_info.limits.used_orders }} / {{ tariff_info.limits.max_orders }}
            <small class="text-muted">({{ tariff_info.percentages.orders }}%)</small>
            {% if tariff_info.percentages.orders >= 100 %}
              <i class="bi bi-exclamation-circle-fill text-danger"></i>
            {% elif tariff_info.percentages.orders >= 80 %}
              <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            {% endif %}
          {% endif %}
        </div>
      </div>
      
      <div class="row g-2">
        {% if valid_to %}
        <div class="col-12">
          <strong>Срок действия тарифа:</strong>
          {% if is_expired %}
            <span class="text-danger">Истёк {{ valid_to }}</span>
          {% else %}
            <span>До {{ valid_to }}</span>
          {% endif %}
        </div>
        {% else %}
        <div class="col-12">
          <strong>Срок действия:</strong> <span class="text-success">Бессрочный</span>
        </div>
        {% endif %}
        
        {% if tariff_info.automation %}
        <div class="col-12">
          <strong>Автоматизация:</strong>
          {% set features = [] %}
          {% if tariff_info.automation.auto_manufacture_year %}
            {% set _ = features.append("Год выпуска СИ") %}
          {% endif %}
          {% if tariff_info.automation.auto_teams %}
            {% set _ = features.append("Команды") %}
          {% endif %}
          {% if tariff_info.automation.auto_metrolog %}
            {% set _ = features.append("Метрологическая информация") %}
          {% endif %}
          {% if features %}
            {{ features | join(", ") }}
          {% else %}
            <span class="text-muted">Нет</span>
          {% endif %}
        </div>
        {% endif %}
      </div>
      
      {% if is_expired %}
      <hr class="my-2">
      <p class="mb-0 text-danger">
        <strong>Внимание!</strong> Тариф истёк. Обратитесь к администратору для продления.
      </p>
      {% endif %}
    </div>
  {% else %}
    <div class="alert alert-warning mb-4 text-center">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill"></i>
        Тариф не назначен
      </h5>
      <p class="mb-0">
        У компании отсутствует активный тариф. Обратитесь к администратору для назначения тарифа.
      </p>
    </div>
  {% endif %}
{% endif %}

<div class="row justify-content-center g-4 py-3">
  {% if status != "auditor" %}
  {% set tiles = [
  ('verification','Поверка','Регистрация, просмотр и управление результатами поверки СИ.', '/verification'),
  ('calendar','Календарь','Формирование заявок, построение графика поверок и ведение отчетности.', '/calendar'),
  ('employee','Сотрудники','Управление сотрудниками компании.', '/companies/employees'),
  ('city','Населённые пункты','Управление населёнными пунктами компании.', '/companies/cities'),
  ('verifier','Поверители','Управление поверителями компании.', '/companies/verifiers'),
  ('equipment','Карточки оборудования','Управление оборудованием компании.', '/companies/equipments'),
  ('team','Команды','Управление командами компании.', '/companies/teams') if company_auto_teams or status=='admin' else None,
  ('registry_number','Номера гос.реестра','Управление номерами гос.реестра компании.', '/companies/registry-numbers'),
  ('method','Методики','Управление методиками компании.', '/companies/methods'),
  ('modification','Модификации СИ','Управление модификациями СИ компании.', '/companies/si-modifications'),
  ('act_series','Серии бланков','Управление сериями бланков компании.', '/companies/act-series'),
  ('reason','Причины непригодности','Управление причинами непригодности компании.', '/companies/reasons'),
  ('location','Расположения счётчика','Управление местами установки счётчиков компании.', '/companies/locations'),
  ('act_number','Номера бланков','Управление номерами бланков компании.', '/companies/act-numbers'),
  ('route','Маршруты','Управление маршрутами компании.', '/companies/routes'),
  ('verification_report','Настр. отчёты (Поверка)','Управление настраиваемыми отчётами в разделе «Поверка».', '/companies/verification-reports'),
  ('calendar_report','Настр. отчёты (Календарь)','Управление настраиваемыми отчётами в разделе «Календарь».', '/companies/calendar-reports'),
  ] %}
  {% else %}
  {% set tiles = [
  ('verification','Поверка','Регистрация, просмотр и управление результатами поверки СИ.', '/verification'),
  ('calendar','Календарь','Формирование заявок, построение графика поверок и ведение отчетности.', '/calendar'),
  ('verifier','Поверители','Управление поверителями компании.', '/companies/verifiers'),
  ('equipment','Карточки оборудования','Управление оборудованием компании.', '/companies/equipments'),
  ] %}
  {% endif %}

  {% for item in tiles if item %}
  {% set key,title,subtitle,direct = item %}
  {% set bg = (
  'background-color: rgb(181, 242, 250);' if key=='verification' or key=='verification_report'
  else 'background-color: rgb(181, 250, 196);' if key=='calendar' or key=='calendar_report'
  else 'background-color: rgb(243, 252, 192);'
  ) %}
  <div class="
    {% if key in ['verification','calendar'] %}
      col-12 col-xl-6
    {% else %}
      col-12 col-xl-4
    {% endif %}
  ">
    <div class="company-card card h-100" role="button" style="{{ bg }}"
      onclick="location.href='{{ direct }}?company_id={{ company_id }}'">
      <div class="card-body p-4">
        <h3 class="card-title text-center">{{ title }}</h3>
        <hr>
        <p class="card-text text-center">
          {{ subtitle }}
        </p>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}
