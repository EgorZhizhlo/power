{% extends 'base.html' %}

{% set is_create = (view_type == 'create') %}
{% set page_title = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' if is_create else ('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ ' ~ company.name) %}

{% block title %}
{{ last_name|capitalize }} {{ name|capitalize }} {{ patronymic|capitalize }} | {{ page_title }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<h1 class="fs-xl d-flex flex-column align-items-center mb-4">

  {# ‚Äî‚Äì‚Äì 1. –õ–æ–≥–æ—Ç–∏–ø ‚Äî‚Äì‚Äì #}
  {% if not is_create and company_image %}
  <div class="photo mb-3">
    <img src="data:image/jpeg;base64,{{ company_image }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏: {{ company.name }}">
  </div>
  {% endif %}

  {# ‚Äî‚Äì‚Äì 2. –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî‚Äì‚Äì #}
  <div class="btn-group mb-3">
    <a href="/companies" class="btn btn-outline-dark label-text fw-bold" style="border-width: 3px;">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
  </div>

  {{ page_title }}
</h1>

<div class="card p-4 mb-5">
  <form
    id ="company-form"
    method="{% if is_create %}POST{% else %}PUT{% endif %}"
    action="{% if is_create %}/companies/api/create{% else %}/companies/api/update?company_id={{company.id}}{% endif %}">

    {# === 1. –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (3 –≤ —Ä—è–¥) === #}
    <div class="row gx-3 gy-4 mb-4">
      {% for field,label in [
      ('name','–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏'),
      ('email','–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞'),
      ] %}
      <div class="col-md-4">
        <label for="{{ field }}" class="form-label label-text"><b>{{ label }}</b></label>
        <input type="text" id="{{ field }}" name="{{ field }}" class="form-control text-center input-text"
          value="{{ (company | attr(field)) if not is_create else '' }}" {% if field in ['name'] %}required{% endif %}>
      </div>
      {% endfor %}

      <div class="col-md-4">
        <label for="inn" class="form-label label-text"><b>–ò–ù–ù</b></label>
        <input type="text" id="inn" name="inn"
          class="form-control text-center input-text"
          value="{{ (company | attr('inn')) if not is_create else '' }}"
          minlength="10" maxlength="12" pattern="\d{10,12}" required>
      </div>

      {% for field,label in [
      ('address','–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏'),
      ('workplace','–ú–µ—Å—Ç–æ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏'),
      ('accreditation_certificat','–ê—Ç—Ç–µ—Å—Ç–∞—Ç –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏'),
      ('organization_code','–®–∏—Ñ—Ä –∑–Ω–∞–∫–∞ –ø–æ–≤–µ—Ä–∫–∏'),
      ('contact_responsible_person','–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞'),
      ] %}
      <div class="col-md-4">
        <label for="{{ field }}" class="form-label label-text"><b>{{ label }}</b></label>
        <input type="text" id="{{ field }}" name="{{ field }}" class="form-control text-center input-text"
          value="{{ (company | attr(field)) if not is_create else '' }}" {% if field in ['name'] %}required{% endif %}>
      </div>
      {% endfor %}

      {% for field,label in [
      ('additional','–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'),
      ] %}
      <div class="col-md-4">
        <label for="{{ field }}" class="form-label label-text"><b>{{ label }}</b></label>
        <input type="text" id="{{ field }}" name="{{ field }}" class="form-control text-center input-text"
          value="{{ (company | attr(field)) if not is_create else '' }}">
      </div>
      {% endfor %}

      {% for field,label in [
      ('longitude','–î–æ–ª–≥–æ—Ç–∞'),
      ('latitude','–®–∏—Ä–æ—Ç–∞'),
      ('default_pressure','–î–∞–≤–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
      ] %}
      <div class="col-md-4">
        <label for="{{ field }}" class="form-label label-text"><b>{{ label }}</b></label>
        <input type="text" id="{{ field }}" name="{{ field }}" class="form-control text-center input-text"
          value="{% if not is_create %}{{ company | attr(field) or 0 }}{% else %}0{% endif %}">
      </div>
      {% endfor %}

      <div class="col-md-3">
        <label for="timezone" class="form-label label-text"><b>–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞</b></label>
        <select id="timezone" name="timezone" class="form-select text-center input-text">
          {% for tz_id, tz_name in timezones %}
          <option value="{{ tz_id }}" {% if not is_create and company.timezone == tz_id %}selected{% elif is_create and tz_id == 'Europe/Moscow' %}selected{% endif %}>
            {{ tz_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      {% if status == 'admin' or (status == 'director' and (not is_create) and company.auto_teams) %}
        <div class="col-md-3">
          <label for="daily_verifier_verif_limit" class="form-label label-text"><b>–ö–æ–ª-–≤–æ –ø–æ–≤–µ—Ä–æ–∫ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</b></label>
          <input type="number" id="daily_verifier_verif_limit" name="daily_verifier_verif_limit" class="form-control text-center input-text" min="0"
            value="{% if not is_create %}{{ company.daily_verifier_verif_limit or 0 }}{% else %}0{% endif %}">
        </div>
        <div class="col-md-6">
          <label for="yandex_disk_token" class="form-label label-text"><b>API-–∫–ª—é—á –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫</b></label>
          <input type="text" id="yandex_disk_token" name="yandex_disk_token" class="form-control text-center input-text"
            value="{% if not is_create %}{{ company.yandex_disk_token if company.yandex_disk_token else '' }}{% else %}{% endif %}">
        </div>
      {% endif %}

      {% if status == 'admin' %}
        <div class="col-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <h6 class="card-title mb-2"><i class="bi bi-people-fill"></i> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ¬´–ö–æ–º–∞–Ω–¥—ã¬ª</h6>
              {% if not is_create %}
              <span class="badge {% if company.auto_teams %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                {% if company.auto_teams %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif %}
              </span>
              {% else %}
              <span class="badge bg-secondary mb-2">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>
              {% endif %}
              <small class="text-muted d-block"><i class="bi bi-info-circle"></i> –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∞—Ä–∏—Ñ—ã"</small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <h6 class="card-title mb-2"><i class="bi bi-gear-fill"></i> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ¬´–ú–µ—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏¬ª</h6>
              {% if not is_create %}
              <span class="badge {% if company.auto_metrolog %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                {% if company.auto_metrolog %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif %}
              </span>
              {% else %}
              <span class="badge bg-secondary mb-2">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>
              {% endif %}
              <small class="text-muted d-block"><i class="bi bi-info-circle"></i> –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∞—Ä–∏—Ñ—ã"</small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <h6 class="card-title mb-2"><i class="bi bi-calendar-event"></i> –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–¥–∞ –≤—ã–ø—É—Å–∫–∞ –°–ò</h6>
              {% if not is_create %}
              <span class="badge {% if company.auto_manufacture_year %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                {% if company.auto_manufacture_year %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif %}
              </span>
              {% else %}
              <span class="badge bg-secondary mb-2">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>
              {% endif %}
              <small class="text-muted d-block"><i class="bi bi-info-circle"></i> –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∞—Ä–∏—Ñ—ã"</small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <h6 class="card-title mb-2"><i class="bi bi-building-check"></i> –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–∞–Ω–∏–∏</h6>
              {% if not is_create %}
              <span class="badge {% if company.is_active %}bg-success{% else %}bg-danger{% endif %} mb-2">
                {% if company.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}
              </span>
              {% else %}
              <span class="badge bg-secondary mb-2">–ù–µ –∞–∫—Ç–∏–≤–Ω–∞</span>
              {% endif %}
              <small class="text-muted d-block"><i class="bi bi-info-circle"></i> –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∞—Ä–∏—Ñ—ã"</small>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    {% if status == 'admin' %}
      <hr class="my-4">

      <div class="card p-3 mb-4">
        <h5 class="mb-3 text-center">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏</h5>

        <label for="employee_ids" class="form-label label-text"><b>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</b></label>
        <select id="employee_ids" name="employee_ids" multiple class="form-select">
          {% for emp in all_employees %}
          {% set fio = (emp.last_name|capitalize ~ ' ' ~ emp.name|capitalize ~ ' ' ~ (emp.patronymic or '')|capitalize)
          %}
          {% set status_map = {'admin':'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä','director':'–î–∏—Ä–µ–∫—Ç–æ—Ä','auditor':'–ê—É–¥–∏—Ç–æ—Ä'} %}
          {% set label_status = status_map.get(emp.status, emp.status) %}
          <option value="{{ emp.id }}" {% if not is_create and emp.id in selected_employee_ids %}selected{% endif %}>
            {{ fio }} ‚Äî {{ label_status }}
          </option>
          {% endfor %}
        </select>

        <p class="text-muted mt-0 mb-0 fs-sm">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û –∏–ª–∏ —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>
      </div>
    {% endif %}

    <hr class="my-4">

    {# === 2. –ë–ª–æ–∫–∏ –≤–∫–ª–∞–¥–æ–∫ (2 –∫–æ–ª–æ–Ω–∫–∏ –ø–æ 50%) === #}
    <div class="row">
      {# --- –ü–æ–ª—è –≤—ã–±–æ—Ä–∞ --- #}
      <div class="col-lg-6">
        <div class="card p-3 mb-4 h-100">
          <h5 class="mb-3 text-center">–ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤—ã–±–æ—Ä–∞</h5>
          <ul class="nav nav-tabs" id="tabSelectFields" role="tablist">
            {% for num in range(1,6) %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if num == 1 %}active{% endif %}" id="tab-select-{{ num }}" data-bs-toggle="tab"
                data-bs-target="#select-{{ num }}" type="button" role="tab">
                –ü–æ–ª–µ ‚Ññ{{ num }}
              </button>
            </li>
            {% endfor %}
          </ul>
          <div class="tab-content p-3 border border-top-0 rounded-bottom">
            {% for num in range(1,6) %}
            <div class="tab-pane fade {% if num == 1 %}show active{% endif %}" id="select-{{ num }}" role="tabpanel">
              <input type="text" id="additional_checkbox_{{ num }}" name="additional_checkbox_{{ num }}"
                class="form-control text-center input-text"
                value="{{ (company | attr('additional_checkbox_' ~ num|string)) if not is_create else '' }}">
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {# --- –ü–æ–ª—è –≤–≤–æ–¥–∞ --- #}
      <div class="col-lg-6">
        <div class="card p-3 mb-4 h-100">
          <h5 class="mb-3 text-center">–ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞</h5>
          <ul class="nav nav-tabs" id="tabInputFields" role="tablist">
            {% for num in range(1,6) %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if num == 1 %}active{% endif %}" id="tab-input-{{ num }}" data-bs-toggle="tab"
                data-bs-target="#input-{{ num }}" type="button" role="tab">
                –ü–æ–ª–µ ‚Ññ{{ num }}
              </button>
            </li>
            {% endfor %}
          </ul>
          <div class="tab-content p-3 border border-top-0 rounded-bottom">
            {% for num in range(1,6) %}
            <div class="tab-pane fade {% if num == 1 %}show active{% endif %}" id="input-{{ num }}" role="tabpanel">
              <input type="text" id="additional_input_{{ num }}" name="additional_input_{{ num }}"
                class="form-control text-center input-text"
                value="{{ (company | attr('additional_input_' ~ num|string)) if not is_create else '' }}">
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

    {# === 3. –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –æ–ø—Ü–∏–∏ (—á–µ–∫–±–æ–∫—Å—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É) === #}
    <div class="row gx-3 gy-4 mb-4">
      {% for field,label in [
      ('customer_field','¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª'),
      ('price_field','¬´–¶–µ–Ω–∞¬ª'),
      ('water_field','¬´–í–æ–¥–∞¬ª')
      ] %}
      <div class="col-md-4">
        <div class="border rounded p-3 h-100 text-center">
          <p class="label-text fw-bold mb-3">–ü–æ–ª–µ {{ label }}</p>
          <div class="form-check d-flex justify-content-center align-items-center mb-2">
            <input type="checkbox" name="{{ field }}" class="form-check-input me-2" {% if company_calendar_params and
              (company_calendar_params|attr(field)) %}checked{% endif %}>
            <label class="form-check-label label-text"><b>–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å</b></label>
          </div>
          <div class="form-check d-flex justify-content-center align-items-center">
            <input type="checkbox" name="{{ field }}_required" class="form-check-input me-2" {% if
              company_calendar_params and (company_calendar_params|attr(field ~ '_required' )) %}checked{% endif %}>
            <label class="form-check-label label-text"><b>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</b></label>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-outline-success label-text fw-bold" style="border-width: 3px;">
        {% if is_create %}‚úÖ –°–æ–∑–¥–∞—Ç—å{% else %}‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% endif %}
      </button>
    </div>
  </form>
</div>

<script>
  window.isCreate = {{ is_create|tojson }};
  window.userStatus = '{{ status }}';
  {% if not is_create %}
  window.companyId = {{ company.id }};
  {% endif %}
</script>
<script type="module" src="/static/company/companies_menu/js/update_or_create.js"></script>

{% endblock %}
